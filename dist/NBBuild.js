"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : new P(function (resolve) { resolve(result.value); }).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
Object.defineProperty(exports, "__esModule", { value: true });
const path = require("path");
const fs = require("fs-promise");
const SafetyCheck_1 = require("./SafetyCheck");
const NODEBLOG_ROOT = '<!--NODEBLOG_ROOT-->';
const NODEBLOG_BINDINGS = '[/*NODEBLOG_BINDINGS*/]';
const NODEBLOG_IMPORT = '<!--NODEBLOG_IMPORT-->';
const divider = '-'.repeat(48);
class NBBuild {
    constructor(save, outputDir) {
        this.save = save;
        this.outputDir = outputDir;
    }
    buildAll(validate) {
        return __awaiter(this, void 0, void 0, function* () {
            let startTime = Date.now();
            console.log(divider);
            console.log(`Building site: ${this.save.getMetadata().name} (v${this.save.getMetadata().version})\noutput: ${this.outputDir}`);
            console.log(divider);
            yield fs.ensureDir(this.outputDir);
            if (validate) {
                console.log('Running static checks on site');
                yield new SafetyCheck_1.SafetyCheck(this.save).checkAll();
                console.log('Everything checks out! (you deserve a pat on the back)');
                console.log(divider);
            }
            let buildPromises = [];
            for (let schemaName of yield this.save.getSchemaNames()) {
                buildPromises.push(this.buildTemplate(schemaName));
            }
            yield Promise.all(buildPromises);
            console.log('copying dependencies');
            yield this.copyDependencies();
            console.log('copying data');
            yield this.copyData();
            console.log(divider);
            console.log(`Build complete in ${(Date.now() - startTime) / 1000} seconds`);
            console.log(divider);
        });
    }
    buildTemplate(schemaName) {
        return __awaiter(this, void 0, void 0, function* () {
            console.log('building template: ' + schemaName);
            let schema = yield this.save.getSchema(schemaName);
            let elements = yield this.save.getElementManifests();
            let template = yield this.save.getTemplate(schemaName);
            let pageElements = '';
            let bindings = [];
            let neededImports = '';
            let currentId = 0;
            for (let pgElement of template) {
                let builtIn = pgElement.elementTag.indexOf('-') == -1;
                for (let bind of pgElement.bindings) {
                    bindings.push({ value: bind.value, property: bind.property, elemId: 'nb' + currentId });
                }
                pageElements += `<div class="nbelement"><${pgElement.elementTag} id="${'nb' + (currentId++)}" /></div>\n`;
                if (!builtIn) {
                    let element = elements.get(pgElement.elementTag);
                    if (element.importType == 'script') {
                        neededImports += `<script src="${element.href}"></script>\n`;
                    }
                    else if (element.importType == 'html') {
                        neededImports += `<link rel="import" href="${element.href}">\n`;
                    }
                }
            }
            console.log('writing template to page');
            yield this.writePage(schemaName, pageElements, bindings, neededImports);
        });
    }
    writePage(schema, pageElements, bindings, neededImports) {
        return __awaiter(this, void 0, void 0, function* () {
            let originalText = yield this.save.getBasePage();
            originalText = originalText.replace(NODEBLOG_ROOT, pageElements).replace(NODEBLOG_BINDINGS, JSON.stringify(bindings)).replace(NODEBLOG_IMPORT, neededImports);
            yield fs.ensureFile(path.resolve(this.outputDir, schema + '.html'));
            yield fs.writeFile(path.resolve(this.outputDir, schema + '.html'), originalText, 'UTF-8');
        });
    }
    copyDependencies() {
        return __awaiter(this, void 0, void 0, function* () {
            yield fs.copy(path.resolve(this.save.savePath, 'elements'), path.resolve(this.outputDir, 'elements'));
        });
    }
    copyData() {
        return __awaiter(this, void 0, void 0, function* () {
            yield fs.copy(this.save.dataPath, path.resolve(this.outputDir, 'data'));
        });
    }
}
exports.NBBuild = NBBuild;
function getFieldType(schema, name) {
    for (let field of schema) {
        if (field.name == name) {
            return field.type;
        }
    }
    return null;
}
function getPropertyType(element, name) {
    if (element.properties[name] != undefined) {
        return element.properties[name];
    }
    return null;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiTkJCdWlsZC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL05CQnVpbGQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7OztBQUFBLDZCQUE4QjtBQUU5QixpQ0FBaUM7QUFFakMsK0NBQTBDO0FBUTFDLE1BQU0sYUFBYSxHQUFHLHNCQUFzQixDQUFDO0FBQzdDLE1BQU0saUJBQWlCLEdBQUcseUJBQXlCLENBQUM7QUFDcEQsTUFBTSxlQUFlLEdBQUcsd0JBQXdCLENBQUM7QUFDakQsTUFBTSxPQUFPLEdBQUcsR0FBRyxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUMsQ0FBQztBQUMvQjtJQVFJLFlBQVksSUFBYyxFQUFFLFNBQWlCO1FBQ3pDLElBQUksQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDO1FBQ2pCLElBQUksQ0FBQyxTQUFTLEdBQUcsU0FBUyxDQUFDO0lBQy9CLENBQUM7SUFLWSxRQUFRLENBQUMsUUFBaUI7O1lBQ25DLElBQUksU0FBUyxHQUFHLElBQUksQ0FBQyxHQUFHLEVBQUUsQ0FBQztZQUMzQixPQUFPLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxDQUFDO1lBQ3JCLE9BQU8sQ0FBQyxHQUFHLENBQUMsa0JBQWtCLElBQUksQ0FBQyxJQUFJLENBQUMsV0FBVyxFQUFFLENBQUMsSUFBSSxNQUFNLElBQUksQ0FBQyxJQUFJLENBQUMsV0FBVyxFQUFFLENBQUMsT0FBTyxjQUFjLElBQUksQ0FBQyxTQUFTLEVBQUUsQ0FBQyxDQUFDO1lBQy9ILE9BQU8sQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLENBQUM7WUFDckIsTUFBTSxFQUFFLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQztZQUNuQyxFQUFFLENBQUEsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDO2dCQUNWLE9BQU8sQ0FBQyxHQUFHLENBQUMsK0JBQStCLENBQUMsQ0FBQztnQkFDN0MsTUFBTSxJQUFJLHlCQUFXLENBQUMsSUFBSSxDQUFD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RSxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxTQUFTLEVBQUUsVUFBVSxDQUFDLENBQUMsQ0FBQztRQUMxRyxDQUFDO0tBQUE7SUFDYSxRQUFROztZQUNsQixNQUFNLEVBQUUsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxRQUFRLEVBQUUsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsU0FBUyxFQUFFLE1BQU0sQ0FBQyxDQUFDLENBQUM7UUFDNUUsQ0FBQztLQUFBO0NBQ0o7QUFyRkQsMEJBcUZDO0FBTUQsc0JBQXNCLE1BQWUsRUFBRSxJQUFZO0lBQy9DLEdBQUcsQ0FBQSxDQUFDLElBQUksS0FBSyxJQUFJLE1BQU0sQ0FBQyxDQUFDLENBQUM7UUFDdEIsRUFBRSxDQUFBLENBQUMsS0FBSyxDQUFDLElBQUksSUFBSSxJQUFJLENBQUMsQ0FBQyxDQUFDO1lBQ3BCLE1BQU0sQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDO1FBQ3RCLENBQUM7SUFDTCxDQUFDO0lBQ0QsTUFBTSxDQUFDLElBQUksQ0FBQztBQUNoQixDQUFDO0FBQ0QseUJBQXlCLE9BQXdCLEVBQUUsSUFBWTtJQUMzRCxFQUFFLENBQUEsQ0FBQyxPQUFPLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxJQUFJLFNBQVMsQ0FBQyxDQUFDLENBQUM7UUFDdkMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDcEMsQ0FBQztJQUNELE1BQU0sQ0FBQyxJQUFJLENBQUM7QUFDaEIsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqICBhcyBwYXRoIGZyb20gJ3BhdGgnO1xyXG5pbXBvcnQge1NhdmVGaWxlfSBmcm9tICcuL1NhdmVGaWxlJztcclxuaW1wb3J0ICogYXMgZnMgZnJvbSAnZnMtcHJvbWlzZSc7XHJcbmltcG9ydCB7UGFnZUVsZW1lbnQsIEJpbmRpbmcsIEVsZW1lbnRNYW5pZmVzdCwgRmllbGQsIHJlY29nbml6ZWRUeXBlc30gZnJvbSAnLi9GaWxlVHlwZXMnO1xyXG5pbXBvcnQge1NhZmV0eUNoZWNrfSBmcm9tICcuL1NhZmV0eUNoZWNrJztcclxuaW1wb3J0ICogYXMgTkJlcnJzIGZyb20gJy4vRXJyb3JUeXBlcyc7XHJcbmludGVyZmFjZSBCaW5kaW5nQ29tbWFuZCB7XHJcbiAgICB2YWx1ZTogc3RyaW5nO1xyXG4gICAgZWxlbUlkOiBzdHJpbmc7XHJcbiAgICBwcm9wZXJ0eTogc3RyaW5nO1xyXG59XHJcbi8vY29uc3RzIHRoYXQgZ2V0IHJlcGxhY2VkIChzaXRlIGNhbm5vdCBoYXZlIHRoZXNlKVxyXG5jb25zdCBOT0RFQkxPR19ST09UID0gJzwhLS1OT0RFQkxPR19ST09ULS0+JztcclxuY29uc3QgTk9ERUJMT0dfQklORElOR1MgPSAnWy8qTk9ERUJMT0dfQklORElOR1MqL10nO1xyXG5jb25zdCBOT0RFQkxPR19JTVBPUlQgPSAnPCEtLU5PREVCTE9HX0lNUE9SVC0tPic7XHJcbmNvbnN0IGRpdmlkZXIgPSAnLScucmVwZWF0KDQ4KTtcclxuZXhwb3J0IGNsYXNzIE5CQnVpbGQge1xyXG4gICAgcHJpdmF0ZSBzYXZlOiBTYXZlRmlsZTtcclxuICAgIHByaXZhdGUgb3V0cHV0RGlyOiBzdHJpbmc7XHJcbiAgICAvKipcclxuICAgICAqIENyZWF0ZXMgbmV3IE5CQnVpbGQgaW5zdGFuY2VcclxuICAgICAqIEBwYXJhbSBzYXZlIHRoZSBzYXZlIGZpbGUgdG8gcmVhZCBmcm9tXHJcbiAgICAgKiBAcGFyYW0gb3V0cHV0RGlyIHRoZSBkaXJlY3RvcnkgdG8gd3JpdGUgdG9cclxuICAgICAqL1xyXG4gICAgY29uc3RydWN0b3Ioc2F2ZTogU2F2ZUZpbGUsIG91dHB1dERpcjogc3RyaW5nKSB7XHJcbiAgICAgICAgdGhpcy5zYXZlID0gc2F2ZTtcclxuICAgICAgICB0aGlzLm91dHB1dERpciA9IG91dHB1dERpcjtcclxuICAgIH1cclxuICAgIC8qKlxyXG4gICAgICogQnVpbGRzIHRoZSBwcm9qZWN0IVxyXG4gICAgICogQHBhcmFtIHZhbGlkYXRlIGNoZWNrICh0cnVlKSBvciBub3QgY2hlY2sgKGZhbHNlKSB0aGUgZmlsZXMgdG8gc2VlIGlmIHRoZSB0eXBlcyBtYXRjaCB1cFxyXG4gICAgICovXHJcbiAgICBwdWJsaWMgYXN5bmMgYnVpbGRBbGwodmFsaWRhdGU6IGJvb2xlYW4pIHtcclxuICAgICAgICBsZXQgc3RhcnRUaW1lID0gRGF0ZS5ub3coKTtcclxuICAgICAgICBjb25zb2xlLmxvZyhkaXZpZGVyKTtcclxuICAgICAgICBjb25zb2xlLmxvZyhgQnVpbGRpbmcgc2l0ZTogJHt0aGlzLnNhdmUuZ2V0TWV0YWRhdGEoKS5uYW1lfSAodiR7dGhpcy5zYXZlLmdldE1ldGFkYXRhKCkudmVyc2lvbn0pXFxub3V0cHV0OiAke3RoaXMub3V0cHV0RGlyfWApO1xyXG4gICAgICAgIGNvbnNvbGUubG9nKGRpdmlkZXIpO1xyXG4gICAgICAgIGF3YWl0IGZzLmVuc3VyZURpcih0aGlzLm91dHB1dERpcik7XHJcbiAgICAgICAgaWYodmFsaWRhdGUpIHtcclxuICAgICAgICAgICAgY29uc29sZS5sb2coJ1J1bm5pbmcgc3RhdGljIGNoZWNrcyBvbiBzaXRlJyk7XHJcbiAgICAgICAgICAgIGF3YWl0IG5ldyBTYWZldHlDaGVjayh0aGlzLnNhdmUpLmNoZWNrQWxsKCk7XHJcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKCdFdmVyeXRoaW5nIGNoZWNrcyBvdXQhICh5b3UgZGVzZXJ2ZSBhIHBhdCBvbiB0aGUgYmFjayknKTtcclxuICAgICAgICAgICAgY29uc29sZS5sb2coZGl2aWRlcik7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGxldCBidWlsZFByb21pc2VzOiBBcnJheTxQcm9taXNlPGFueT4+ID0gW107XHJcbiAgICAgICAgZm9yKGxldCBzY2hlbWFOYW1lIG9mIGF3YWl0IHRoaXMuc2F2ZS5nZXRTY2hlbWFOYW1lcygpKSB7XHJcbiAgICAgICAgICAgIGJ1aWxkUHJvbWlzZXMucHVzaCh0aGlzLmJ1aWxkVGVtcGxhdGUoc2NoZW1hTmFtZSkpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBhd2FpdCBQcm9taXNlLmFsbChidWlsZFByb21pc2VzKTtcclxuICAgICAgICBjb25zb2xlLmxvZygnY29weWluZyBkZXBlbmRlbmNpZXMnKTtcclxuICAgICAgICBhd2FpdCB0aGlzLmNvcHlEZXBlbmRlbmNpZXMoKTtcclxuICAgICAgICBjb25zb2xlLmxvZygnY29weWluZyBkYXRhJyk7XHJcbiAgICAgICAgYXdhaXQgdGhpcy5jb3B5RGF0YSgpO1xyXG4gICAgICAgIGNvbnNvbGUubG9nKGRpdmlkZXIpO1xyXG4gICAgICAgIGNvbnNvbGUubG9nKGBCdWlsZCBjb21wbGV0ZSBpbiAkeyhEYXRlLm5vdygpLXN0YXJ0VGltZSkvMTAwMH0gc2Vjb25kc2ApO1xyXG4gICAgICAgIGNvbnNvbGUubG9nKGRpdmlkZXIpO1xyXG4gICAgfVxyXG4gICAgcHJpdmF0ZSBhc3luYyBidWlsZFRlbXBsYXRlIChzY2hlbWFOYW1lOiBzdHJpbmcpIHtcclxuICAgICAgICBjb25zb2xlLmxvZygnYnVpbGRpbmcgdGVtcGxhdGU6ICcrc2NoZW1hTmFtZSk7XHJcbiAgICAgICAgLy9uZWVkZWQgZnJvbSBzYXZlIGZpbGVcclxuICAgICAgICBsZXQgc2NoZW1hID0gYXdhaXQgdGhpcy5zYXZlLmdldFNjaGVtYShzY2hlbWFOYW1lKTtcclxuICAgICAgICBsZXQgZWxlbWVudHMgPSBhd2FpdCB0aGlzLnNhdmUuZ2V0RWxlbWVudE1hbmlmZXN0cygpO1xyXG4gICAgICAgIGxldCB0ZW1wbGF0ZSA9IGF3YWl0IHRoaXMuc2F2ZS5nZXRUZW1wbGF0ZShzY2hlbWFOYW1lKTtcclxuICAgICAgICAvL2hvbGRlcnMgZm9yIGZpbmFsIHJlc3VsdFxyXG4gICAgICAgIGxldCBwYWdlRWxlbWVudHMgPSAnJztcclxuICAgICAgICBsZXQgYmluZGluZ3M6IEJpbmRpbmdDb21tYW5kW10gPSBbXTtcclxuICAgICAgICBsZXQgbmVlZGVkSW1wb3J0cyA9ICcnO1xyXG4gICAgICAgIGxldCBjdXJyZW50SWQgPSAwO1xyXG4gICAgICAgIC8vYnVpbGQgbG9vcFxyXG4gICAgICAgIGZvcihsZXQgcGdFbGVtZW50IG9mIHRlbXBsYXRlKSB7XHJcbiAgICAgICAgICAgIGxldCBidWlsdEluID0gcGdFbGVtZW50LmVsZW1lbnRUYWcuaW5kZXhPZignLScpID09IC0xO1xyXG4gICAgICAgICAgICBmb3IobGV0IGJpbmQgb2YgcGdFbGVtZW50LmJpbmRpbmdzKSB7XHJcbiAgICAgICAgICAgICAgICBiaW5kaW5ncy5wdXNoKHt2YWx1ZTogYmluZC52YWx1ZSwgcHJvcGVydHk6IGJpbmQucHJvcGVydHksIGVsZW1JZDogJ25iJytjdXJyZW50SWR9KTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAvL3dlbGwgaWYgbm90aGluZydzIGJsb3duIHVwIHlldFxyXG4gICAgICAgICAgICBwYWdlRWxlbWVudHMgKz0gYDxkaXYgY2xhc3M9XCJuYmVsZW1lbnRcIj48JHtwZ0VsZW1lbnQuZWxlbWVudFRhZ30gaWQ9XCIkeyduYicrKGN1cnJlbnRJZCsrKX1cIiAvPjwvZGl2PlxcbmA7XHJcbiAgICAgICAgICAgIGlmKCFidWlsdEluKSB7XHJcbiAgICAgICAgICAgICAgICBsZXQgZWxlbWVudCA9IGVsZW1lbnRzLmdldChwZ0VsZW1lbnQuZWxlbWVudFRhZyk7XHJcbiAgICAgICAgICAgICAgICBpZihlbGVtZW50LmltcG9ydFR5cGUgPT0gJ3NjcmlwdCcpIHtcclxuICAgICAgICAgICAgICAgICAgICBuZWVkZWRJbXBvcnRzICs9IGA8c2NyaXB0IHNyYz1cIiR7ZWxlbWVudC5ocmVmfVwiPjwvc2NyaXB0PlxcbmBcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGVsc2UgaWYoZWxlbWVudC5pbXBvcnRUeXBlID09ICdodG1sJykge1xyXG4gICAgICAgICAgICAgICAgICAgIG5lZWRlZEltcG9ydHMgKz0gYDxsaW5rIHJlbD1cImltcG9ydFwiIGhyZWY9XCIke2VsZW1lbnQuaHJlZn1cIj5cXG5gO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGNvbnNvbGUubG9nKCd3cml0aW5nIHRlbXBsYXRlIHRvIHBhZ2UnKTtcclxuICAgICAgICBhd2FpdCB0aGlzLndyaXRlUGFnZShzY2hlbWFOYW1lLCBwYWdlRWxlbWVudHMsIGJpbmRpbmdzLCBuZWVkZWRJbXBvcnRzKTtcclxuICAgIH1cclxuICAgIHByaXZhdGUgYXN5bmMgd3JpdGVQYWdlKHNjaGVtYTogc3RyaW5nLCBwYWdlRWxlbWVudHM6IHN0cmluZywgYmluZGluZ3M6IEJpbmRpbmdDb21tYW5kW10sIG5lZWRlZEltcG9ydHM6IHN0cmluZykge1xyXG4gICAgICAgIGxldCBvcmlnaW5hbFRleHQgPSBhd2FpdCB0aGlzLnNhdmUuZ2V0QmFzZVBhZ2UoKTtcclxuICAgICAgICBvcmlnaW5hbFRleHQgPSBvcmlnaW5hbFRleHQucmVwbGFjZShOT0RFQkxPR19ST09ULCBwYWdlRWxlbWVudHMpLnJlcGxhY2UoTk9ERUJMT0dfQklORElOR1MsIEpTT04uc3RyaW5naWZ5KGJpbmRpbmdzKSkucmVwbGFjZShOT0RFQkxPR19JTVBPUlQsIG5lZWRlZEltcG9ydHMpO1xyXG4gICAgICAgIGF3YWl0IGZzLmVuc3VyZUZpbGUocGF0aC5yZXNvbHZlKHRoaXMub3V0cHV0RGlyLCBzY2hlbWErJy5odG1sJykpO1xyXG4gICAgICAgIGF3YWl0IGZzLndyaXRlRmlsZShwYXRoLnJlc29sdmUodGhpcy5vdXRwdXREaXIsIHNjaGVtYSsnLmh0bWwnKSwgb3JpZ2luYWxUZXh0LCAnVVRGLTgnKTtcclxuICAgIH1cclxuICAgIHByaXZhdGUgYXN5bmMgY29weURlcGVuZGVuY2llcygpIHtcclxuICAgICAgICBhd2FpdCBmcy5jb3B5KHBhdGgucmVzb2x2ZSh0aGlzLnNhdmUuc2F2ZVBhdGgsICdlbGVtZW50cycpLCBwYXRoLnJlc29sdmUodGhpcy5vdXRwdXREaXIsICdlbGVtZW50cycpKTtcclxuICAgIH1cclxuICAgIHByaXZhdGUgYXN5bmMgY29weURhdGEgKCkge1xyXG4gICAgICAgIGF3YWl0IGZzLmNvcHkodGhpcy5zYXZlLmRhdGFQYXRoLCBwYXRoLnJlc29sdmUodGhpcy5vdXRwdXREaXIsICdkYXRhJykpO1xyXG4gICAgfVxyXG59XHJcbmludGVyZmFjZSBTb3J0SG9sZGVyIHtcclxuICAgIHZhbHVlOiBudW1iZXI7XHJcbiAgICBmaWxlbmFtZTogc3RyaW5nO1xyXG59XHJcbi8vaGVscGVyIGZ1bmN0aW9uc1xyXG5mdW5jdGlvbiBnZXRGaWVsZFR5cGUoc2NoZW1hOiBGaWVsZFtdLCBuYW1lOiBzdHJpbmcpIHtcclxuICAgIGZvcihsZXQgZmllbGQgb2Ygc2NoZW1hKSB7XHJcbiAgICAgICAgaWYoZmllbGQubmFtZSA9PSBuYW1lKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBmaWVsZC50eXBlO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuICAgIHJldHVybiBudWxsO1xyXG59XHJcbmZ1bmN0aW9uIGdldFByb3BlcnR5VHlwZShlbGVtZW50OiBFbGVtZW50TWFuaWZlc3QsIG5hbWU6IHN0cmluZykge1xyXG4gICAgaWYoZWxlbWVudC5wcm9wZXJ0aWVzW25hbWVdICE9IHVuZGVmaW5lZCkge1xyXG4gICAgICAgIHJldHVybiBlbGVtZW50LnByb3BlcnRpZXNbbmFtZV07XHJcbiAgICB9XHJcbiAgICByZXR1cm4gbnVsbDtcclxufVxyXG4iXX0=