"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : new P(function (resolve) { resolve(result.value); }).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
Object.defineProperty(exports, "__esModule", { value: true });
const fs = require("fs-extra");
const path = require("path");
class SaveFile {
    constructor() {
        this.schemas = new Map();
        this.templates = new Map();
        this.elementManifests = new Map();
        this.basePage = null;
    }
    get dataPath() {
        return path.resolve(this.loadPath, 'data');
    }
    get savePath() {
        return this.loadPath;
    }
    readFrom(dirname) {
        return __awaiter(this, void 0, void 0, function* () {
            this.loadPath = dirname;
            let metaFile = yield fs.readFile(path.resolve(this.loadPath, 'metadata.json'), 'UTF-8');
            this.metadata = SaveFile.parseMetaData(JSON.parse(metaFile));
        });
    }
    static parseMetaData(obj) {
        let toReturn = { name: obj.name, version: obj.version };
        return toReturn;
    }
    static parseFields(obj) {
        let toReturn = [];
        obj.forEach((field) => {
            toReturn.push({ name: field.name, type: field.type.toLowerCase() });
        });
        return toReturn;
    }
    getMetadata() {
        return this.metadata;
    }
    static parsePageElements(obj) {
        let toReturn = [];
        obj.forEach((pageelem) => {
            let thisPageElem = {};
            thisPageElem.elementTag = pageelem.elementTag;
            thisPageElem.bindings = [];
            pageelem.bindings.forEach((binding) => {
                thisPageElem.bindings.push({ property: binding.property, value: binding.value });
            });
            toReturn.push(thisPageElem);
        });
        return toReturn;
    }
    getSchema(name) {
        return __awaiter(this, void 0, void 0, function* () {
            if (this.schemas.has(name)) {
                return this.schemas.get(name);
            }
            let schemaFile = yield fs.readFile(path.resolve(this.loadPath, 'schemas', name + '.json'), 'UTF-8');
            let fields = SaveFile.parseFields(JSON.parse(schemaFile));
            this.schemas.set(name, fields);
            return fields;
        });
    }
    getSchemaNames() {
        return __awaiter(this, void 0, void 0, function* () {
            let schemaDir = yield fs.readdir(path.resolve(this.loadPath, 'schemas'));
            let toReturn = [];
            for (let filename of schemaDir) {
                if (path.extname(filename) === '.json') {
                    let base = path.basename(filename, '.json');
                    toReturn.push(base);
                }
            }
            ;
            return toReturn;
        });
    }
    getTemplate(name) {
        return __awaiter(this, void 0, void 0, function* () {
            if (this.templates.has(name)) {
                return this.templates.get(name);
            }
            let templateFile = yield fs.readFile(path.resolve(this.loadPath, 'templates', name + '.json'), 'UTF-8');
            let pageElems = SaveFile.parsePageElements(JSON.parse(templateFile));
            this.templates.set(name, pageElems);
            return pageElems;
        });
    }
    static parseManifest(obj) {
        let toReturn = { elementTag: obj.elementTag, href: obj.href, importType: obj.importType.toLowerCase(), properties: obj.properties };
        for (let prop in toReturn.properties) {
            toReturn.properties[prop] = toReturn.properties[prop].toLowerCase();
        }
        return toReturn;
    }
    getElementManifests() {
        return __awaiter(this, void 0, void 0, function* () {
            if (this.elementManifests.size != 0) {
                return this.elementManifests;
            }
            let folderDir = path.resolve(this.loadPath, 'elements');
            let folders = yield fs.readdir(folderDir);
            for (let folder of folders) {
                let thisPath = path.resolve(folderDir, folder);
                let stat = yield fs.stat(thisPath);
                if (!stat.isDirectory()) {
                    continue;
                }
                let fileHref = path.resolve(thisPath, 'kangratmanifest.json');
                if (yield fs.exists(fileHref)) {
                    let file = yield fs.readFile(fileHref, 'UTF-8');
                    let manifest = SaveFile.parseManifest(JSON.parse(file));
                    manifest.href = path.relative(this.loadPath, path.resolve(thisPath, manifest.href)).replace(new RegExp('\\' + path.sep, 'g'), '/');
                    this.elementManifests.set(manifest.elementTag, manifest);
                }
            }
            return this.elementManifests;
        });
    }
    getBasePage() {
        return __awaiter(this, void 0, void 0, function* () {
            if (this.basePage != null) {
                return this.basePage;
            }
            let testPath = path.resolve(this.loadPath, 'BasePage.html');
            if (yield fs.exists(testPath)) {
                this.basePage = yield fs.readFile(path.resolve(this.loadPath, 'BasePage.html'), 'UTF-8');
            }
            else {
                this.basePage = yield fs.readFile(path.resolve(__dirname, '../BasePage.html'), 'UTF-8');
            }
            return this.basePage;
        });
    }
}
exports.SaveFile = SaveFile;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiU2F2ZUZpbGUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9TYXZlRmlsZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7O0FBQUEsK0JBQStCO0FBQy9CLDZCQUE2QjtBQUU3QjtJQUFBO1FBRVcsWUFBTyxHQUF5QixJQUFJLEdBQUcsRUFBbUIsQ0FBQztRQUMzRCxjQUFTLEdBQStCLElBQUksR0FBRyxFQUF5QixDQUFDO1FBQ3pFLHFCQUFnQixHQUFpQyxJQUFJLEdBQUcsRUFBMkIsQ0FBQztRQUVwRixhQUFRLEdBQVcsSUFBSSxDQUFDO0lBcUluQyxDQUFDO0lBcElBLElBQVcsUUFBUTtRQUNsQixNQUFNLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsUUFBUSxFQUFFLE1BQU0sQ0FBQyxDQUFDO0lBQzVDLENBQUM7SUFDRCxJQUFXLFFBQVE7UUFDbEIsTUFBTSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUM7SUFDdEIsQ0FBQztJQUtZLFFBQVEsQ0FBRSxPQUFlOztZQUNyQyxJQUFJLENBQUMsUUFBUSxHQUFHLE9BQU8sQ0FBQztZQUN4QixJQUFJLFFBQVEsR0FBRyxNQUFNLEVBQUUsQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsUUFBUSxFQUFFLGVBQWUsQ0FBQyxFQUFFLE9BQU8sQ0FBQyxDQUFDO1lBQ3hGLElBQUksQ0FBQyxRQUFRLEdBQUcsUUFBUSxDQUFDLGFBQWEsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUM7UUFDOUQsQ0FBQztLQUFBO0lBQ00sTUFBTSxDQUFDLGFBQWEsQ0FBRSxHQUFRO1FBQ3BDLElBQUksUUFBUSxHQUFHLEVBQUMsSUFBSSxFQUFFLEdBQUcsQ0FBQyxJQUFJLEVBQUUsT0FBTyxFQUFFLEdBQUcsQ0FBQyxPQUFPLEVBQUMsQ0FBQztRQUN0RCxNQUFNLENBQUMsUUFBb0IsQ0FBQztJQUM3QixDQUFDO0lBQ00sTUFBTSxDQUFDLFdBQVcsQ0FBRSxHQUFVO1FBQ3BDLElBQUksUUFBUSxHQUFZLEVBQUUsQ0FBQztRQUMzQixHQUFHLENBQUMsT0FBTyxDQUFDLENBQUMsS0FBSztZQUNqQixRQUFRLENBQUMsSUFBSSxDQUFDLEVBQUMsSUFBSSxFQUFFLEtBQUssQ0FBQyxJQUFJLEVBQUUsSUFBSSxFQUFFLEtBQUssQ0FBQyxJQUFJLENBQUMsV0FBVyxFQUFFLEVBQVUsQ0FBQyxDQUFDO1FBQzVFLENBQUMsQ0FBQyxDQUFBO1FBQ0YsTUFBTSxDQUFDLFFBQVEsQ0FBQztJQUNqQixDQUFDO0lBQ00sV0FBVztRQUNqQixNQUFNLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQztJQUN0QixDQUFDO0lBRU0sTUFBTSxDQUFDLGlCQUFpQixDQUFFLEdBQVU7UUFDMUMsSUFBSSxRQUFRLEdBQWtCLEVBQUUsQ0FBQztRQUNqQyxHQUFHLENBQUMsT0FBTyxDQUFDLENBQUMsUUFBcUI7WUFDakMsSUFBSSxZQUFZLEdBQVEsRUFBRSxDQUFDO1lBQzNCLFlBQVksQ0FBQyxVQUFVLEdBQUcsUUFBUSxDQUFDLFVBQVUsQ0FBQztZQUM5QyxZQUFZLENBQUMsUUFBUSxHQUFHLEVBQUUsQ0FBQztZQUMzQixRQUFRLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxDQUFDLE9BQWdCO2dCQUMxQyxZQUFZLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxFQUFDLFFBQVEsRUFBRSxPQUFPLENBQUMsUUFBUSxFQUFFLEtBQUssRUFBRSxPQUFPLENBQUMsS0FBSyxFQUFZLENBQUMsQ0FBQztZQUMzRixDQUFDLENBQUMsQ0FBQztZQUNILFFBQVEsQ0FBQyxJQUFJLENBQUMsWUFBMkIsQ0FBQyxDQUFDO1FBQzVDLENBQUMsQ0FBQyxDQUFBO1FBQ0YsTUFBTSxDQUFDLFFBQVEsQ0FBQztJQUNqQixDQUFDO0lBS1ksU0FBUyxDQUFDLElBQVk7O1lBQ2xDLEVBQUUsQ0FBQSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztnQkFDM0IsTUFBTSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBWSxDQUFDO1lBQzFDLENBQUM7WUFDRCxJQUFJLFVBQVUsR0FBRyxNQUFNLEVBQUUsQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsUUFBUSxFQUFFLFNBQVMsRUFBRSxJQUFJLEdBQUMsT0FBTyxDQUFDLEVBQUUsT0FBTyxDQUFDLENBQUM7WUFDbEcsSUFBSSxNQUFNLEdBQUcsUUFBUSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUM7WUFDMUQsSUFBSSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsSUFBSSxFQUFFLE1BQU0sQ0FBQyxDQUFDO1lBQy9CLE1BQU0sQ0FBQyxNQUFNLENBQUM7UUFDZixDQUFDO0tBQUE7SUFJWSxjQUFjOztZQUMxQixJQUFJLFNBQVMsR0FBRyxNQUFNLEVBQUUsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsUUFBUSxFQUFFLFNBQVMsQ0FBQyxDQUFDLENBQUM7WUFDekUsSUFBSSxRQUFRLEdBQWEsRUFBRSxDQUFDO1lBQzVCLEdBQUcsQ0FBQSxDQUFDLElBQUksUUFBUSxJQUFJLFNBQVMsQ0FBQyxDQUFDLENBQUM7Z0JBQy9CLEVBQUUsQ0FBQSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDLEtBQUssT0FBTyxDQUFDLENBQUMsQ0FBQztvQkFDdkMsSUFBSSxJQUFJLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxRQUFRLEVBQUUsT0FBTyxDQUFDLENBQUM7b0JBQzVDLFFBQVEsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7Z0JBQ3JCLENBQUM7WUFDRixDQUFDO1lBQUEsQ0FBQztZQUNGLE1BQU0sQ0FBQyxRQUFRLENBQUM7UUFDakIsQ0FBQztLQUFBO0lBS1ksV0FBVyxDQUFDLElBQVk7O1lBQ3BDLEVBQUUsQ0FBQSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztnQkFDN0IsTUFBTSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBa0IsQ0FBQztZQUNsRCxDQUFDO1lBQ0QsSUFBSSxZQUFZLEdBQUcsTUFBTSxFQUFFLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLFFBQVEsRUFBRSxXQUFXLEVBQUUsSUFBSSxHQUFDLE9BQU8sQ0FBQyxFQUFFLE9BQU8sQ0FBQyxDQUFDO1lBQ3RHLElBQUksU0FBUyxHQUFHLFFBQVEsQ0FBQyxpQkFBaUIsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLFlBQVksQ0FBQyxDQUFDLENBQUM7WUFDckUsSUFBSSxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsSUFBSSxFQUFFLFNBQVMsQ0FBQyxDQUFDO1lBQ3BDLE1BQU0sQ0FBQyxTQUFTLENBQUM7UUFDbEIsQ0FBQztLQUFBO0lBRU0sTUFBTSxDQUFDLGFBQWEsQ0FBRSxHQUFRO1FBQ3BDLElBQUksUUFBUSxHQUFHLEVBQUMsVUFBVSxFQUFFLEdBQUcsQ0FBQyxVQUFVLEVBQUUsSUFBSSxFQUFFLEdBQUcsQ0FBQyxJQUFJLEVBQUUsVUFBVSxFQUFFLEdBQUcsQ0FBQyxVQUFVLENBQUMsV0FBVyxFQUFFLEVBQUUsVUFBVSxFQUFFLEdBQUcsQ0FBQyxVQUFVLEVBQUMsQ0FBQztRQUNsSSxHQUFHLENBQUEsQ0FBQyxJQUFJLElBQUksSUFBSSxRQUFRLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQztZQUNyQyxRQUFRLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxHQUFHLFFBQVEsQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLENBQUMsV0FBVyxFQUFFLENBQUM7UUFDckUsQ0FBQztRQUNELE1BQU0sQ0FBQyxRQUFRLENBQUM7SUFDakIsQ0FBQztJQUlZLG1CQUFtQjs7WUFDL0IsRUFBRSxDQUFBLENBQUMsSUFBSSxDQUFDLGdCQUFnQixDQUFDLElBQUksSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO2dCQUNwQyxNQUFNLENBQUMsSUFBSSxDQUFDLGdCQUFnQixDQUFDO1lBQzlCLENBQUM7WUFDRCxJQUFJLFNBQVMsR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxRQUFRLEVBQUUsVUFBVSxDQUFDLENBQUM7WUFDeEQsSUFBSSxPQUFPLEdBQUcsTUFBTSxFQUFFLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQyxDQUFDO1lBQzFDLEdBQUcsQ0FBQSxDQUFDLElBQUksTUFBTSxJQUFJLE9BQU8sQ0FBQyxDQUFDLENBQUM7Z0JBQzNCLElBQUksUUFBUSxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsU0FBUyxFQUFFLE1BQU0sQ0FBQyxDQUFDO2dCQUMvQyxJQUFJLElBQUksR0FBRyxNQUFNLEVBQUUsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUM7Z0JBQ25DLEVBQUUsQ0FBQSxDQUFDLENBQUMsSUFBSSxDQUFDLFdBQVcsRUFBRSxDQUFDLENBQUMsQ0FBQztvQkFDeEIsUUFBUSxDQUFDO2dCQUNWLENBQUM7Z0JBQ0QsSUFBSSxRQUFRLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxRQUFRLEVBQUUsc0JBQXNCLENBQUMsQ0FBQztnQkFDOUQsRUFBRSxDQUFBLENBQUMsTUFBTSxFQUFFLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsQ0FBQztvQkFDOUIsSUFBSSxJQUFJLEdBQUcsTUFBTSxFQUFFLENBQUMsUUFBUSxDQUFDLFFBQVEsRUFBRSxPQUFPLENBQUMsQ0FBQztvQkFDaEQsSUFBSSxRQUFRLEdBQUcsUUFBUSxDQUFDLGFBQWEsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7b0JBQ3hELFFBQVEsQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsUUFBUSxFQUFFLElBQUksQ0FBQyxPQUFPLENBQUMsUUFBUSxFQUFFLFFBQVEsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxJQUFJLE1BQU0sQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDLEdBQUcsRUFBRSxHQUFHLENBQUMsRUFBRSxHQUFHLENBQUMsQ0FBQztvQkFDbkksSUFBSSxDQUFDLGdCQUFnQixDQUFDLEdBQUcsQ0FBQyxRQUFRLENBQUMsVUFBVSxFQUFFLFFBQVEsQ0FBQyxDQUFDO2dCQUMxRCxDQUFDO1lBQ0YsQ0FBQztZQUNELE1BQU0sQ0FBQyxJQUFJLENBQUMsZ0JBQWdCLENBQUM7UUFDOUIsQ0FBQztLQUFBO0lBSVksV0FBVzs7WUFDdkIsRUFBRSxDQUFBLENBQUMsSUFBSSxDQUFDLFFBQVEsSUFBSSxJQUFJLENBQUMsQ0FBQyxDQUFDO2dCQUMxQixNQUFNLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQztZQUN0QixDQUFDO1lBQ0QsSUFBSSxRQUFRLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsUUFBUSxFQUFFLGVBQWUsQ0FBQyxDQUFDO1lBQzVELEVBQUUsQ0FBQSxDQUFDLE1BQU0sRUFBRSxDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLENBQUM7Z0JBQzlCLElBQUksQ0FBQyxRQUFRLEdBQUcsTUFBTSxFQUFFLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLFFBQVEsRUFBRSxlQUFlLENBQUMsRUFBRSxPQUFPLENBQUMsQ0FBQztZQUMxRixDQUFDO1lBQ0QsSUFBSSxDQUFDLENBQUM7Z0JBQ0wsSUFBSSxDQUFDLFFBQVEsR0FBRyxNQUFNLEVBQUUsQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxTQUFTLEVBQUUsa0JBQWtCLENBQUMsRUFBRSxPQUFPLENBQUMsQ0FBQztZQUN6RixDQUFDO1lBQ0QsTUFBTSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUM7UUFDdEIsQ0FBQztLQUFBO0NBQ0Q7QUEzSUQsNEJBMklDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgZnMgZnJvbSAnZnMtZXh0cmEnO1xyXG5pbXBvcnQgKiBhcyBwYXRoIGZyb20gJ3BhdGgnO1xyXG5pbXBvcnQge01ldGFEYXRhLCBGaWVsZCwgUGFnZUVsZW1lbnQsIEJpbmRpbmcsIEVsZW1lbnRNYW5pZmVzdH0gZnJvbSAnLi9GaWxlVHlwZXMnO1xyXG5leHBvcnQgY2xhc3MgU2F2ZUZpbGUge1xyXG5cdHByb3RlY3RlZCBtZXRhZGF0YTogTWV0YURhdGE7XHJcblx0cHJvdGVjdGVkIHNjaGVtYXM6IE1hcDxzdHJpbmcsIEZpZWxkW10+ID0gbmV3IE1hcDxzdHJpbmcsIEZpZWxkW10+KCk7XHJcblx0cHJvdGVjdGVkIHRlbXBsYXRlczogTWFwPHN0cmluZywgUGFnZUVsZW1lbnRbXT4gPSBuZXcgTWFwPHN0cmluZywgUGFnZUVsZW1lbnRbXT4oKTtcclxuXHRwcm90ZWN0ZWQgZWxlbWVudE1hbmlmZXN0czogTWFwPHN0cmluZywgRWxlbWVudE1hbmlmZXN0PiA9IG5ldyBNYXA8c3RyaW5nLCBFbGVtZW50TWFuaWZlc3Q+KCk7XHJcblx0cHJvdGVjdGVkIGxvYWRQYXRoOiBzdHJpbmc7XHJcblx0cHJvdGVjdGVkIGJhc2VQYWdlOiBzdHJpbmcgPSBudWxsO1xyXG5cdHB1YmxpYyBnZXQgZGF0YVBhdGggKCkge1xyXG5cdFx0cmV0dXJuIHBhdGgucmVzb2x2ZSh0aGlzLmxvYWRQYXRoLCAnZGF0YScpO1xyXG5cdH1cclxuXHRwdWJsaWMgZ2V0IHNhdmVQYXRoICgpIHtcclxuXHRcdHJldHVybiB0aGlzLmxvYWRQYXRoO1xyXG5cdH1cclxuXHQvKipcclxuXHQgKiBSZWFkcyBhIHNhdmUgZGlyZWN0b3J5IChtdXN0IGJlIGNhbGxlZCBiZWZvcmUgZXZlcnl0aGluZyBlbHNlIG9uIHRoaXMgaW5zdGFuY2UpXHJcblx0ICogQHBhcmFtIGRpcm5hbWUgdGhlIGRpcmVjdG9yeSB0byByZWFkIGZyb21cclxuXHQgKi9cclxuXHRwdWJsaWMgYXN5bmMgcmVhZEZyb20gKGRpcm5hbWU6IHN0cmluZykge1xyXG5cdFx0dGhpcy5sb2FkUGF0aCA9IGRpcm5hbWU7XHJcblx0XHRsZXQgbWV0YUZpbGUgPSBhd2FpdCBmcy5yZWFkRmlsZShwYXRoLnJlc29sdmUodGhpcy5sb2FkUGF0aCwgJ21ldGFkYXRhLmpzb24nKSwgJ1VURi04Jyk7XHJcblx0XHR0aGlzLm1ldGFkYXRhID0gU2F2ZUZpbGUucGFyc2VNZXRhRGF0YShKU09OLnBhcnNlKG1ldGFGaWxlKSk7XHJcblx0fVxyXG5cdHB1YmxpYyBzdGF0aWMgcGFyc2VNZXRhRGF0YSAob2JqOiBhbnkpOiBNZXRhRGF0YSB7XHJcblx0XHRsZXQgdG9SZXR1cm4gPSB7bmFtZTogb2JqLm5hbWUsIHZlcnNpb246IG9iai52ZXJzaW9ufTtcclxuXHRcdHJldHVybiB0b1JldHVybiBhcyBNZXRhRGF0YTtcclxuXHR9XHJcblx0cHVibGljIHN0YXRpYyBwYXJzZUZpZWxkcyAob2JqOiBhbnlbXSk6IEZpZWxkW10ge1xyXG5cdFx0bGV0IHRvUmV0dXJuOiBGaWVsZFtdID0gW107XHJcblx0XHRvYmouZm9yRWFjaCgoZmllbGQpID0+IHtcclxuXHRcdFx0dG9SZXR1cm4ucHVzaCh7bmFtZTogZmllbGQubmFtZSwgdHlwZTogZmllbGQudHlwZS50b0xvd2VyQ2FzZSgpfSBhcyBGaWVsZCk7XHJcblx0XHR9KVxyXG5cdFx0cmV0dXJuIHRvUmV0dXJuO1xyXG5cdH1cclxuXHRwdWJsaWMgZ2V0TWV0YWRhdGEgKCk6IE1ldGFEYXRhIHtcclxuXHRcdHJldHVybiB0aGlzLm1ldGFkYXRhO1xyXG5cdH1cclxuXHQvL3NjaGVtYXMgYW5kIHRlbXBsYXRlc1xyXG5cdHB1YmxpYyBzdGF0aWMgcGFyc2VQYWdlRWxlbWVudHMgKG9iajogYW55W10pOiBQYWdlRWxlbWVudFtdIHtcclxuXHRcdGxldCB0b1JldHVybjogUGFnZUVsZW1lbnRbXSA9IFtdO1xyXG5cdFx0b2JqLmZvckVhY2goKHBhZ2VlbGVtOiBQYWdlRWxlbWVudCkgPT4ge1xyXG5cdFx0XHRsZXQgdGhpc1BhZ2VFbGVtOiBhbnkgPSB7fTtcclxuXHRcdFx0dGhpc1BhZ2VFbGVtLmVsZW1lbnRUYWcgPSBwYWdlZWxlbS5lbGVtZW50VGFnO1xyXG5cdFx0XHR0aGlzUGFnZUVsZW0uYmluZGluZ3MgPSBbXTtcclxuXHRcdFx0cGFnZWVsZW0uYmluZGluZ3MuZm9yRWFjaCgoYmluZGluZzogQmluZGluZykgPT4ge1xyXG5cdFx0XHRcdHRoaXNQYWdlRWxlbS5iaW5kaW5ncy5wdXNoKHtwcm9wZXJ0eTogYmluZGluZy5wcm9wZXJ0eSwgdmFsdWU6IGJpbmRpbmcudmFsdWV9IGFzIEJpbmRpbmcpO1xyXG5cdFx0XHR9KTtcclxuXHRcdFx0dG9SZXR1cm4ucHVzaCh0aGlzUGFnZUVsZW0gYXMgUGFnZUVsZW1lbnQpO1xyXG5cdFx0fSlcclxuXHRcdHJldHVybiB0b1JldHVybjtcclxuXHR9XHJcblx0LyoqXHJcblx0ICogcmV0dXJucyB0aGUgYXJyYXkgb2Ygd2hhdCBmaWVsZHMgdGhlIHNjaGVtYSBjb250YWluc1xyXG5cdCAqIEBwYXJhbSBuYW1lIG5hbWUgb2YgdGhlIHNjaGVtYSB0byBnZXRcclxuXHQgKi9cclxuXHRwdWJsaWMgYXN5bmMgZ2V0U2NoZW1hKG5hbWU6IHN0cmluZyk6IFByb21pc2U8RmllbGRbXT4ge1xyXG5cdFx0aWYodGhpcy5zY2hlbWFzLmhhcyhuYW1lKSkge1xyXG5cdFx0XHRyZXR1cm4gdGhpcy5zY2hlbWFzLmdldChuYW1lKSBhcyBGaWVsZFtdOyAvL3NpbGx5IHR5cGVzY3JpcHRcclxuXHRcdH1cclxuXHRcdGxldCBzY2hlbWFGaWxlID0gYXdhaXQgZnMucmVhZEZpbGUocGF0aC5yZXNvbHZlKHRoaXMubG9hZFBhdGgsICdzY2hlbWFzJywgbmFtZSsnLmpzb24nKSwgJ1VURi04Jyk7XHJcblx0XHRsZXQgZmllbGRzID0gU2F2ZUZpbGUucGFyc2VGaWVsZHMoSlNPTi5wYXJzZShzY2hlbWFGaWxlKSk7XHJcblx0XHR0aGlzLnNjaGVtYXMuc2V0KG5hbWUsIGZpZWxkcyk7XHJcblx0XHRyZXR1cm4gZmllbGRzO1xyXG5cdH1cclxuXHQvKipcclxuXHQgKiBSZXR1cm5zIHRoZSBuYW1lcyBvZiBhbGwgdGhlIHNjaGVtYXNcclxuXHQgKi9cclxuXHRwdWJsaWMgYXN5bmMgZ2V0U2NoZW1hTmFtZXMgKCk6IFByb21pc2U8c3RyaW5nW10+IHtcclxuXHRcdGxldCBzY2hlbWFEaXIgPSBhd2FpdCBmcy5yZWFkZGlyKHBhdGgucmVzb2x2ZSh0aGlzLmxvYWRQYXRoLCAnc2NoZW1hcycpKTtcclxuXHRcdGxldCB0b1JldHVybjogc3RyaW5nW10gPSBbXTtcclxuXHRcdGZvcihsZXQgZmlsZW5hbWUgb2Ygc2NoZW1hRGlyKSB7XHJcblx0XHRcdGlmKHBhdGguZXh0bmFtZShmaWxlbmFtZSkgPT09ICcuanNvbicpIHtcclxuXHRcdFx0XHRsZXQgYmFzZSA9IHBhdGguYmFzZW5hbWUoZmlsZW5hbWUsICcuanNvbicpO1xyXG5cdFx0XHRcdHRvUmV0dXJuLnB1c2goYmFzZSk7XHJcblx0XHRcdH1cclxuXHRcdH07XHJcblx0XHRyZXR1cm4gdG9SZXR1cm47XHJcblx0fVxyXG5cdC8qKlxyXG5cdCAqIGdldHMgdGhlIHRlbXBsYXRlIGRlZmluaXRpb24gb2YgYSBzY2hlbWFcclxuXHQgKiBAcGFyYW0gbmFtZSBUaGUgbmFtZSBvZiB0aGUgdGVtcGxhdGUgdG8gZ2V0XHJcblx0ICovXHJcblx0cHVibGljIGFzeW5jIGdldFRlbXBsYXRlKG5hbWU6IHN0cmluZyk6IFByb21pc2U8UGFnZUVsZW1lbnRbXT4ge1xyXG5cdFx0aWYodGhpcy50ZW1wbGF0ZXMuaGFzKG5hbWUpKSB7XHJcblx0XHRcdHJldHVybiB0aGlzLnRlbXBsYXRlcy5nZXQobmFtZSkgYXMgUGFnZUVsZW1lbnRbXTsgLy9zaWxseSB0eXBlc2NyaXB0XHJcblx0XHR9XHJcblx0XHRsZXQgdGVtcGxhdGVGaWxlID0gYXdhaXQgZnMucmVhZEZpbGUocGF0aC5yZXNvbHZlKHRoaXMubG9hZFBhdGgsICd0ZW1wbGF0ZXMnLCBuYW1lKycuanNvbicpLCAnVVRGLTgnKTtcclxuXHRcdGxldCBwYWdlRWxlbXMgPSBTYXZlRmlsZS5wYXJzZVBhZ2VFbGVtZW50cyhKU09OLnBhcnNlKHRlbXBsYXRlRmlsZSkpO1xyXG5cdFx0dGhpcy50ZW1wbGF0ZXMuc2V0KG5hbWUsIHBhZ2VFbGVtcyk7XHJcblx0XHRyZXR1cm4gcGFnZUVsZW1zO1xyXG5cdH1cclxuXHQvL2VsZW1lbnQgbWFuaWZlc3Qgc3R1ZmZcclxuXHRwdWJsaWMgc3RhdGljIHBhcnNlTWFuaWZlc3QgKG9iajogYW55KTogRWxlbWVudE1hbmlmZXN0IHtcclxuXHRcdGxldCB0b1JldHVybiA9IHtlbGVtZW50VGFnOiBvYmouZWxlbWVudFRhZywgaHJlZjogb2JqLmhyZWYsIGltcG9ydFR5cGU6IG9iai5pbXBvcnRUeXBlLnRvTG93ZXJDYXNlKCksIHByb3BlcnRpZXM6IG9iai5wcm9wZXJ0aWVzfTtcclxuXHRcdGZvcihsZXQgcHJvcCBpbiB0b1JldHVybi5wcm9wZXJ0aWVzKSB7XHJcblx0XHRcdHRvUmV0dXJuLnByb3BlcnRpZXNbcHJvcF0gPSB0b1JldHVybi5wcm9wZXJ0aWVzW3Byb3BdLnRvTG93ZXJDYXNlKCk7XHJcblx0XHR9XHJcblx0XHRyZXR1cm4gdG9SZXR1cm47XHJcblx0fVxyXG5cdC8qKlxyXG5cdCAqIEdldHMgcmVnaXN0ZXJlZCBlbGVtZW50IG1hbmlmZXN0c1xyXG5cdCAqL1xyXG5cdHB1YmxpYyBhc3luYyBnZXRFbGVtZW50TWFuaWZlc3RzICgpIHtcclxuXHRcdGlmKHRoaXMuZWxlbWVudE1hbmlmZXN0cy5zaXplICE9IDApIHtcclxuXHRcdFx0cmV0dXJuIHRoaXMuZWxlbWVudE1hbmlmZXN0cztcclxuXHRcdH1cclxuXHRcdGxldCBmb2xkZXJEaXIgPSBwYXRoLnJlc29sdmUodGhpcy5sb2FkUGF0aCwgJ2VsZW1lbnRzJyk7XHJcblx0XHRsZXQgZm9sZGVycyA9IGF3YWl0IGZzLnJlYWRkaXIoZm9sZGVyRGlyKTtcclxuXHRcdGZvcihsZXQgZm9sZGVyIG9mIGZvbGRlcnMpIHtcclxuXHRcdFx0bGV0IHRoaXNQYXRoID0gcGF0aC5yZXNvbHZlKGZvbGRlckRpciwgZm9sZGVyKTtcclxuXHRcdFx0bGV0IHN0YXQgPSBhd2FpdCBmcy5zdGF0KHRoaXNQYXRoKTtcclxuXHRcdFx0aWYoIXN0YXQuaXNEaXJlY3RvcnkoKSkge1xyXG5cdFx0XHRcdGNvbnRpbnVlO1xyXG5cdFx0XHR9XHJcblx0XHRcdGxldCBmaWxlSHJlZiA9IHBhdGgucmVzb2x2ZSh0aGlzUGF0aCwgJ2thbmdyYXRtYW5pZmVzdC5qc29uJyk7XHJcblx0XHRcdGlmKGF3YWl0IGZzLmV4aXN0cyhmaWxlSHJlZikpIHtcclxuXHRcdFx0XHRsZXQgZmlsZSA9IGF3YWl0IGZzLnJlYWRGaWxlKGZpbGVIcmVmLCAnVVRGLTgnKTtcclxuXHRcdFx0XHRsZXQgbWFuaWZlc3QgPSBTYXZlRmlsZS5wYXJzZU1hbmlmZXN0KEpTT04ucGFyc2UoZmlsZSkpO1x0XHRcdFx0XHRcclxuXHRcdFx0XHRtYW5pZmVzdC5ocmVmID0gcGF0aC5yZWxhdGl2ZSh0aGlzLmxvYWRQYXRoLCBwYXRoLnJlc29sdmUodGhpc1BhdGgsIG1hbmlmZXN0LmhyZWYpKS5yZXBsYWNlKG5ldyBSZWdFeHAoJ1xcXFwnICsgcGF0aC5zZXAsICdnJyksICcvJyk7IC8vc2xhc2ggZm9yIHdlYiBzZXJ2ZXIgY29tcGF0aWJpbGl0eVxyXG5cdFx0XHRcdHRoaXMuZWxlbWVudE1hbmlmZXN0cy5zZXQobWFuaWZlc3QuZWxlbWVudFRhZywgbWFuaWZlc3QpO1xyXG5cdFx0XHR9XHJcblx0XHR9XHJcblx0XHRyZXR1cm4gdGhpcy5lbGVtZW50TWFuaWZlc3RzO1xyXG5cdH1cclxuXHQvKipcclxuXHQgKiBHZXRzIHRoZSBhc3NvY2lhdGVkIGJhc2UgcGFnZSwgb3IgaWYgbm9uZSBpcyBmb3VuZCB1c2UgdGhlIHVnbHkgZGVmYXVsdCBvbmVcclxuXHQgKi9cclxuXHRwdWJsaWMgYXN5bmMgZ2V0QmFzZVBhZ2UoKSB7XHJcblx0XHRpZih0aGlzLmJhc2VQYWdlICE9IG51bGwpIHtcclxuXHRcdFx0cmV0dXJuIHRoaXMuYmFzZVBhZ2U7XHJcblx0XHR9XHJcblx0XHRsZXQgdGVzdFBhdGggPSBwYXRoLnJlc29sdmUodGhpcy5sb2FkUGF0aCwgJ0Jhc2VQYWdlLmh0bWwnKTtcclxuXHRcdGlmKGF3YWl0IGZzLmV4aXN0cyh0ZXN0UGF0aCkpIHtcclxuXHRcdFx0dGhpcy5iYXNlUGFnZSA9IGF3YWl0IGZzLnJlYWRGaWxlKHBhdGgucmVzb2x2ZSh0aGlzLmxvYWRQYXRoLCAnQmFzZVBhZ2UuaHRtbCcpLCAnVVRGLTgnKTtcclxuXHRcdH1cclxuXHRcdGVsc2Uge1xyXG5cdFx0XHR0aGlzLmJhc2VQYWdlID0gYXdhaXQgZnMucmVhZEZpbGUocGF0aC5yZXNvbHZlKF9fZGlybmFtZSwgJy4uL0Jhc2VQYWdlLmh0bWwnKSwgJ1VURi04Jyk7XHJcblx0XHR9XHJcblx0XHRyZXR1cm4gdGhpcy5iYXNlUGFnZTtcclxuXHR9XHJcbn0iXX0=