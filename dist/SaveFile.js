"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : new P(function (resolve) { resolve(result.value); }).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
Object.defineProperty(exports, "__esModule", { value: true });
const fs = require("fs-promise");
const path = require("path");
class SaveFile {
    constructor() {
        this.schemas = new Map();
        this.templates = new Map();
        this.elementManifests = new Map();
        this.basePage = null;
    }
    get dataPath() {
        return path.resolve(this.loadPath, 'data');
    }
    get savePath() {
        return this.loadPath;
    }
    readFrom(dirname) {
        return __awaiter(this, void 0, void 0, function* () {
            this.loadPath = dirname;
            let metaFile = yield fs.readFile(path.resolve(this.loadPath, 'metadata.json'), 'UTF-8');
            this.metadata = SaveFile.parseMetaData(JSON.parse(metaFile));
        });
    }
    static parseMetaData(obj) {
        let toReturn = { name: obj.name, version: obj.version };
        return toReturn;
    }
    static parseFields(obj) {
        let toReturn = [];
        obj.forEach((field) => {
            toReturn.push({ name: field.name, type: field.type.toLowerCase() });
        });
        return toReturn;
    }
    getMetadata() {
        return this.metadata;
    }
    static parsePageElements(obj) {
        let toReturn = [];
        obj.forEach((pageelem) => {
            let thisPageElem = {};
            thisPageElem.elementTag = pageelem.elementTag;
            thisPageElem.bindings = [];
            pageelem.bindings.forEach((binding) => {
                thisPageElem.bindings.push({ property: binding.property, value: binding.value });
            });
            toReturn.push(thisPageElem);
        });
        return toReturn;
    }
    getSchema(name) {
        return __awaiter(this, void 0, void 0, function* () {
            if (this.schemas.has(name)) {
                return this.schemas.get(name);
            }
            let schemaFile = yield fs.readFile(path.resolve(this.loadPath, 'schemas', name + '.json'), 'UTF-8');
            let fields = SaveFile.parseFields(JSON.parse(schemaFile));
            this.schemas.set(name, fields);
            return fields;
        });
    }
    getSchemaNames() {
        return __awaiter(this, void 0, void 0, function* () {
            let schemaDir = yield fs.readdir(path.resolve(this.loadPath, 'schemas'));
            let toReturn = [];
            for (let filename of schemaDir) {
                if (path.extname(filename) === '.json') {
                    let base = path.basename(filename, '.json');
                    toReturn.push(base);
                }
            }
            ;
            return toReturn;
        });
    }
    getTemplate(name) {
        return __awaiter(this, void 0, void 0, function* () {
            if (this.templates.has(name)) {
                return this.templates.get(name);
            }
            let templateFile = yield fs.readFile(path.resolve(this.loadPath, 'templates', name + '.json'), 'UTF-8');
            let pageElems = SaveFile.parsePageElements(JSON.parse(templateFile));
            this.templates.set(name, pageElems);
            return pageElems;
        });
    }
    static parseManifest(obj) {
        let toReturn = { elementTag: obj.elementTag, href: obj.href, importType: obj.importType.toLowerCase(), properties: obj.properties };
        for (let prop in toReturn.properties) {
            toReturn.properties[prop] = toReturn.properties[prop].toLowerCase();
        }
        return toReturn;
    }
    getElementManifests() {
        return __awaiter(this, void 0, void 0, function* () {
            if (this.elementManifests.size != 0) {
                return this.elementManifests;
            }
            let folderDir = path.resolve(this.loadPath, 'elements');
            let folders = yield fs.readdir(folderDir);
            for (let folder of folders) {
                let thisPath = path.resolve(folderDir, folder);
                let stat = yield fs.stat(thisPath);
                if (!stat.isDirectory()) {
                    continue;
                }
                let fileHref = path.resolve(thisPath, 'nodeblogmanifest.json');
                if (yield fs.exists(fileHref)) {
                    let file = yield fs.readFile(fileHref, 'UTF-8');
                    let manifest = SaveFile.parseManifest(JSON.parse(file));
                    manifest.href = path.relative(this.loadPath, path.resolve(thisPath, manifest.href)).replace(new RegExp('\\' + path.sep, 'g'), '/');
                    this.elementManifests.set(manifest.elementTag, manifest);
                }
            }
            return this.elementManifests;
        });
    }
    getBasePage() {
        return __awaiter(this, void 0, void 0, function* () {
            if (this.basePage != null) {
                return this.basePage;
            }
            let testPath = path.resolve(this.loadPath, 'BasePage.html');
            if (yield fs.exists(testPath)) {
                this.basePage = yield fs.readFile(path.resolve(this.loadPath, 'BasePage.html'), 'UTF-8');
            }
            else {
                this.basePage = yield fs.readFile(path.resolve(__dirname, '../BasePage.html'), 'UTF-8');
            }
            return this.basePage;
        });
    }
}
exports.SaveFile = SaveFile;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiU2F2ZUZpbGUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9TYXZlRmlsZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7O0FBQUEsaUNBQWlDO0FBQ2pDLDZCQUE2QjtBQUU3QjtJQUFBO1FBRVcsWUFBTyxHQUF5QixJQUFJLEdBQUcsRUFBbUIsQ0FBQztRQUMzRCxjQUFTLEdBQStCLElBQUksR0FBRyxFQUF5QixDQUFDO1FBQ3pFLHFCQUFnQixHQUFpQyxJQUFJLEdBQUcsRUFBMkIsQ0FBQztRQUVwRixhQUFRLEdBQVcsSUFBSSxDQUFDO0lBcUluQyxDQUFDO0lBcElBLElBQVcsUUFBUTtRQUNsQixNQUFNLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsUUFBUSxFQUFFLE1BQU0sQ0FBQyxDQUFDO0lBQzVDLENBQUM7SUFDRCxJQUFXLFFBQVE7UUFDbEIsTUFBTSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUM7SUFDdEIsQ0FBQztJQUtZLFFBQVEsQ0FBRSxPQUFlOztZQUNyQyxJQUFJLENBQUMsUUFBUSxHQUFHLE9BQU8sQ0FBQztZQUN4QixJQUFJLFFBQVEsR0FBRyxNQUFNLEVBQUUsQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsUUFBUSxFQUFFLGVBQWUsQ0FBQyxFQUFFLE9BQU8sQ0FBQyxDQUFDO1lBQ3hGLElBQUksQ0FBQyxRQUFRLEdBQUcsUUFBUSxDQUFDLGFBQWEsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUM7UUFDOUQsQ0FBQztLQUFBO0lBQ00sTUFBTSxDQUFDLGFBQWEsQ0FBRSxHQUFRO1FBQ3BDLElBQUksUUFBUSxHQUFHLEVBQUMsSUFBSSxFQUFFLEdBQUcsQ0FBQyxJQUFJLEVBQUUsT0FBTyxFQUFFLEdBQUcsQ0FBQyxPQUFPLEVBQUMsQ0FBQztRQUN0RCxNQUFNLENBQUMsUUFBb0IsQ0FBQztJQUM3QixDQUFDO0lBQ00s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YXMgZnMgZnJvbSAnZnMtcHJvbWlzZSc7XHJcbmltcG9ydCAqIGFzIHBhdGggZnJvbSAncGF0aCc7XHJcbmltcG9ydCB7TWV0YURhdGEsIEZpZWxkLCBQYWdlRWxlbWVudCwgQmluZGluZywgRWxlbWVudE1hbmlmZXN0fSBmcm9tICcuL0ZpbGVUeXBlcyc7XHJcbmV4cG9ydCBjbGFzcyBTYXZlRmlsZSB7XHJcblx0cHJvdGVjdGVkIG1ldGFkYXRhOiBNZXRhRGF0YTtcclxuXHRwcm90ZWN0ZWQgc2NoZW1hczogTWFwPHN0cmluZywgRmllbGRbXT4gPSBuZXcgTWFwPHN0cmluZywgRmllbGRbXT4oKTtcclxuXHRwcm90ZWN0ZWQgdGVtcGxhdGVzOiBNYXA8c3RyaW5nLCBQYWdlRWxlbWVudFtdPiA9IG5ldyBNYXA8c3RyaW5nLCBQYWdlRWxlbWVudFtdPigpO1xyXG5cdHByb3RlY3RlZCBlbGVtZW50TWFuaWZlc3RzOiBNYXA8c3RyaW5nLCBFbGVtZW50TWFuaWZlc3Q+ID0gbmV3IE1hcDxzdHJpbmcsIEVsZW1lbnRNYW5pZmVzdD4oKTtcclxuXHRwcm90ZWN0ZWQgbG9hZFBhdGg6IHN0cmluZztcclxuXHRwcm90ZWN0ZWQgYmFzZVBhZ2U6IHN0cmluZyA9IG51bGw7XHJcblx0cHVibGljIGdldCBkYXRhUGF0aCAoKSB7XHJcblx0XHRyZXR1cm4gcGF0aC5yZXNvbHZlKHRoaXMubG9hZFBhdGgsICdkYXRhJyk7XHJcblx0fVxyXG5cdHB1YmxpYyBnZXQgc2F2ZVBhdGggKCkge1xyXG5cdFx0cmV0dXJuIHRoaXMubG9hZFBhdGg7XHJcblx0fVxyXG5cdC8qKlxyXG5cdCAqIFJlYWRzIGEgc2F2ZSBkaXJlY3RvcnkgKG11c3QgYmUgY2FsbGVkIGJlZm9yZSBldmVyeXRoaW5nIGVsc2Ugb24gdGhpcyBpbnN0YW5jZSlcclxuXHQgKiBAcGFyYW0gZGlybmFtZSB0aGUgZGlyZWN0b3J5IHRvIHJlYWQgZnJvbVxyXG5cdCAqL1xyXG5cdHB1YmxpYyBhc3luYyByZWFkRnJvbSAoZGlybmFtZTogc3RyaW5nKSB7XHJcblx0XHR0aGlzLmxvYWRQYXRoID0gZGlybmFtZTtcclxuXHRcdGxldCBtZXRhRmlsZSA9IGF3YWl0IGZzLnJlYWRGaWxlKHBhdGgucmVzb2x2ZSh0aGlzLmxvYWRQYXRoLCAnbWV0YWRhdGEuanNvbicpLCAnVVRGLTgnKTtcclxuXHRcdHRoaXMubWV0YWRhdGEgPSBTYXZlRmlsZS5wYXJzZU1ldGFEYXRhKEpTT04ucGFyc2UobWV0YUZpbGUpKTtcclxuXHR9XHJcblx0cHVibGljIHN0YXRpYyBwYXJzZU1ldGFEYXRhIChvYmo6IGFueSk6IE1ldGFEYXRhIHtcclxuXHRcdGxldCB0b1JldHVybiA9IHtuYW1lOiBvYmoubmFtZSwgdmVyc2lvbjogb2JqLnZlcnNpb259O1xyXG5cdFx0cmV0dXJuIHRvUmV0dXJuIGFzIE1ldGFEYXRhO1xyXG5cdH1cclxuXHRwdWJsaWMgc3RhdGljIHBhcnNlRmllbGRzIChvYmo6IGFueVtdKTogRmllbGRbXSB7XHJcblx0XHRsZXQgdG9SZXR1cm46IEZpZWxkW10gPSBbXTtcclxuXHRcdG9iai5mb3JFYWNoKChmaWVsZCkgPT4ge1xyXG5cdFx0XHR0b1JldHVybi5wdXNoKHtuYW1lOiBmaWVsZC5uYW1lLCB0eXBlOiBmaWVsZC50eXBlLnRvTG93ZXJDYXNlKCl9IGFzIEZpZWxkKTtcclxuXHRcdH0pXHJcblx0XHRyZXR1cm4gdG9SZXR1cm47XHJcblx0fVxyXG5cdHB1YmxpYyBnZXRNZXRhZGF0YSAoKTogTWV0YURhdGEge1xyXG5cdFx0cmV0dXJuIHRoaXMubWV0YWRhdGE7XHJcblx0fVxyXG5cdC8vc2NoZW1hcyBhbmQgdGVtcGxhdGVzXHJcblx0cHVibGljIHN0YXRpYyBwYXJzZVBhZ2VFbGVtZW50cyAob2JqOiBhbnlbXSk6IFBhZ2VFbGVtZW50W10ge1xyXG5cdFx0bGV0IHRvUmV0dXJuOiBQYWdlRWxlbWVudFtdID0gW107XHJcblx0XHRvYmouZm9yRWFjaCgocGFnZWVsZW06IFBhZ2VFbGVtZW50KSA9PiB7XHJcblx0XHRcdGxldCB0aGlzUGFnZUVsZW06IGFueSA9IHt9O1xyXG5cdFx0XHR0aGlzUGFnZUVsZW0uZWxlbWVudFRhZyA9IHBhZ2VlbGVtLmVsZW1lbnRUYWc7XHJcblx0XHRcdHRoaXNQYWdlRWxlbS5iaW5kaW5ncyA9IFtdO1xyXG5cdFx0XHRwYWdlZWxlbS5iaW5kaW5ncy5mb3JFYWNoKChiaW5kaW5nOiBCaW5kaW5nKSA9PiB7XHJcblx0XHRcdFx0dGhpc1BhZ2VFbGVtLmJpbmRpbmdzLnB1c2goe3Byb3BlcnR5OiBiaW5kaW5nLnByb3BlcnR5LCB2YWx1ZTogYmluZGluZy52YWx1ZX0gYXMgQmluZGluZyk7XHJcblx0XHRcdH0pO1xyXG5cdFx0XHR0b1JldHVybi5wdXNoKHRoaXNQYWdlRWxlbSBhcyBQYWdlRWxlbWVudCk7XHJcblx0XHR9KVxyXG5cdFx0cmV0dXJuIHRvUmV0dXJuO1xyXG5cdH1cclxuXHQvKipcclxuXHQgKiByZXR1cm5zIHRoZSBhcnJheSBvZiB3aGF0IGZpZWxkcyB0aGUgc2NoZW1hIGNvbnRhaW5zXHJcblx0ICogQHBhcmFtIG5hbWUgbmFtZSBvZiB0aGUgc2NoZW1hIHRvIGdldFxyXG5cdCAqL1xyXG5cdHB1YmxpYyBhc3luYyBnZXRTY2hlbWEobmFtZTogc3RyaW5nKTogUHJvbWlzZTxGaWVsZFtdPiB7XHJcblx0XHRpZih0aGlzLnNjaGVtYXMuaGFzKG5hbWUpKSB7XHJcblx0XHRcdHJldHVybiB0aGlzLnNjaGVtYXMuZ2V0KG5hbWUpIGFzIEZpZWxkW107IC8vc2lsbHkgdHlwZXNjcmlwdFxyXG5cdFx0fVxyXG5cdFx0bGV0IHNjaGVtYUZpbGUgPSBhd2FpdCBmcy5yZWFkRmlsZShwYXRoLnJlc29sdmUodGhpcy5sb2FkUGF0aCwgJ3NjaGVtYXMnLCBuYW1lKycuanNvbicpLCAnVVRGLTgnKTtcclxuXHRcdGxldCBmaWVsZHMgPSBTYXZlRmlsZS5wYXJzZUZpZWxkcyhKU09OLnBhcnNlKHNjaGVtYUZpbGUpKTtcclxuXHRcdHRoaXMuc2NoZW1hcy5zZXQobmFtZSwgZmllbGRzKTtcclxuXHRcdHJldHVybiBmaWVsZHM7XHJcblx0fVxyXG5cdC8qKlxyXG5cdCAqIFJldHVybnMgdGhlIG5hbWVzIG9mIGFsbCB0aGUgc2NoZW1hc1xyXG5cdCAqL1xyXG5cdHB1YmxpYyBhc3luYyBnZXRTY2hlbWFOYW1lcyAoKTogUHJvbWlzZTxzdHJpbmdbXT4ge1xyXG5cdFx0bGV0IHNjaGVtYURpciA9IGF3YWl0IGZzLnJlYWRkaXIocGF0aC5yZXNvbHZlKHRoaXMubG9hZFBhdGgsICdzY2hlbWFzJykpO1xyXG5cdFx0bGV0IHRvUmV0dXJuOiBzdHJpbmdbXSA9IFtdO1xyXG5cdFx0Zm9yKGxldCBmaWxlbmFtZSBvZiBzY2hlbWFEaXIpIHtcclxuXHRcdFx0aWYocGF0aC5leHRuYW1lKGZpbGVuYW1lKSA9PT0gJy5qc29uJykge1xyXG5cdFx0XHRcdGxldCBiYXNlID0gcGF0aC5iYXNlbmFtZShmaWxlbmFtZSwgJy5qc29uJyk7XHJcblx0XHRcdFx0dG9SZXR1cm4ucHVzaChiYXNlKTtcclxuXHRcdFx0fVxyXG5cdFx0fTtcclxuXHRcdHJldHVybiB0b1JldHVybjtcclxuXHR9XHJcblx0LyoqXHJcblx0ICogZ2V0cyB0aGUgdGVtcGxhdGUgZGVmaW5pdGlvbiBvZiBhIHNjaGVtYVxyXG5cdCAqIEBwYXJhbSBuYW1lIFRoZSBuYW1lIG9mIHRoZSB0ZW1wbGF0ZSB0byBnZXRcclxuXHQgKi9cclxuXHRwdWJsaWMgYXN5bmMgZ2V0VGVtcGxhdGUobmFtZTogc3RyaW5nKTogUHJvbWlzZTxQYWdlRWxlbWVudFtdPiB7XHJcblx0XHRpZih0aGlzLnRlbXBsYXRlcy5oYXMobmFtZSkpIHtcclxuXHRcdFx0cmV0dXJuIHRoaXMudGVtcGxhdGVzLmdldChuYW1lKSBhcyBQYWdlRWxlbWVudFtdOyAvL3NpbGx5IHR5cGVzY3JpcHRcclxuXHRcdH1cclxuXHRcdGxldCB0ZW1wbGF0ZUZpbGUgPSBhd2FpdCBmcy5yZWFkRmlsZShwYXRoLnJlc29sdmUodGhpcy5sb2FkUGF0aCwgJ3RlbXBsYXRlcycsIG5hbWUrJy5qc29uJyksICdVVEYtOCcpO1xyXG5cdFx0bGV0IHBhZ2VFbGVtcyA9IFNhdmVGaWxlLnBhcnNlUGFnZUVsZW1lbnRzKEpTT04ucGFyc2UodGVtcGxhdGVGaWxlKSk7XHJcblx0XHR0aGlzLnRlbXBsYXRlcy5zZXQobmFtZSwgcGFnZUVsZW1zKTtcclxuXHRcdHJldHVybiBwYWdlRWxlbXM7XHJcblx0fVxyXG5cdC8vZWxlbWVudCBtYW5pZmVzdCBzdHVmZlxyXG5cdHB1YmxpYyBzdGF0aWMgcGFyc2VNYW5pZmVzdCAob2JqOiBhbnkpOiBFbGVtZW50TWFuaWZlc3Qge1xyXG5cdFx0bGV0IHRvUmV0dXJuID0ge2VsZW1lbnRUYWc6IG9iai5lbGVtZW50VGFnLCBocmVmOiBvYmouaHJlZiwgaW1wb3J0VHlwZTogb2JqLmltcG9ydFR5cGUudG9Mb3dlckNhc2UoKSwgcHJvcGVydGllczogb2JqLnByb3BlcnRpZXN9O1xyXG5cdFx0Zm9yKGxldCBwcm9wIGluIHRvUmV0dXJuLnByb3BlcnRpZXMpIHtcclxuXHRcdFx0dG9SZXR1cm4ucHJvcGVydGllc1twcm9wXSA9IHRvUmV0dXJuLnByb3BlcnRpZXNbcHJvcF0udG9Mb3dlckNhc2UoKTtcclxuXHRcdH1cclxuXHRcdHJldHVybiB0b1JldHVybjtcclxuXHR9XHJcblx0LyoqXHJcblx0ICogR2V0cyByZWdpc3RlcmVkIGVsZW1lbnQgbWFuaWZlc3RzXHJcblx0ICovXHJcblx0cHVibGljIGFzeW5jIGdldEVsZW1lbnRNYW5pZmVzdHMgKCkge1xyXG5cdFx0aWYodGhpcy5lbGVtZW50TWFuaWZlc3RzLnNpemUgIT0gMCkge1xyXG5cdFx0XHRyZXR1cm4gdGhpcy5lbGVtZW50TWFuaWZlc3RzO1xyXG5cdFx0fVxyXG5cdFx0bGV0IGZvbGRlckRpciA9IHBhdGgucmVzb2x2ZSh0aGlzLmxvYWRQYXRoLCAnZWxlbWVudHMnKTtcclxuXHRcdGxldCBmb2xkZXJzID0gYXdhaXQgZnMucmVhZGRpcihmb2xkZXJEaXIpO1xyXG5cdFx0Zm9yKGxldCBmb2xkZXIgb2YgZm9sZGVycykge1xyXG5cdFx0XHRsZXQgdGhpc1BhdGggPSBwYXRoLnJlc29sdmUoZm9sZGVyRGlyLCBmb2xkZXIpO1xyXG5cdFx0XHRsZXQgc3RhdCA9IGF3YWl0IGZzLnN0YXQodGhpc1BhdGgpO1xyXG5cdFx0XHRpZighc3RhdC5pc0RpcmVjdG9yeSgpKSB7XHJcblx0XHRcdFx0Y29udGludWU7XHJcblx0XHRcdH1cclxuXHRcdFx0bGV0IGZpbGVIcmVmID0gcGF0aC5yZXNvbHZlKHRoaXNQYXRoLCAnbm9kZWJsb2dtYW5pZmVzdC5qc29uJyk7XHJcblx0XHRcdGlmKGF3YWl0IGZzLmV4aXN0cyhmaWxlSHJlZikpIHtcclxuXHRcdFx0XHRsZXQgZmlsZSA9IGF3YWl0IGZzLnJlYWRGaWxlKGZpbGVIcmVmLCAnVVRGLTgnKTtcclxuXHRcdFx0XHRsZXQgbWFuaWZlc3QgPSBTYXZlRmlsZS5wYXJzZU1hbmlmZXN0KEpTT04ucGFyc2UoZmlsZSkpO1x0XHRcdFx0XHRcclxuXHRcdFx0XHRtYW5pZmVzdC5ocmVmID0gcGF0aC5yZWxhdGl2ZSh0aGlzLmxvYWRQYXRoLCBwYXRoLnJlc29sdmUodGhpc1BhdGgsIG1hbmlmZXN0LmhyZWYpKS5yZXBsYWNlKG5ldyBSZWdFeHAoJ1xcXFwnICsgcGF0aC5zZXAsICdnJyksICcvJyk7IC8vc2xhc2ggZm9yIHdlYiBzZXJ2ZXIgY29tcGF0aWJpbGl0eVxyXG5cdFx0XHRcdHRoaXMuZWxlbWVudE1hbmlmZXN0cy5zZXQobWFuaWZlc3QuZWxlbWVudFRhZywgbWFuaWZlc3QpO1xyXG5cdFx0XHR9XHJcblx0XHR9XHJcblx0XHRyZXR1cm4gdGhpcy5lbGVtZW50TWFuaWZlc3RzO1xyXG5cdH1cclxuXHQvKipcclxuXHQgKiBHZXRzIHRoZSBhc3NvY2lhdGVkIGJhc2UgcGFnZSwgb3IgaWYgbm9uZSBpcyBmb3VuZCB0aGUgdWdseSBkZWZhdWx0IG9uZVxyXG5cdCAqL1xyXG5cdHB1YmxpYyBhc3luYyBnZXRCYXNlUGFnZSgpIHtcclxuXHRcdGlmKHRoaXMuYmFzZVBhZ2UgIT0gbnVsbCkge1xyXG5cdFx0XHRyZXR1cm4gdGhpcy5iYXNlUGFnZTtcclxuXHRcdH1cclxuXHRcdGxldCB0ZXN0UGF0aCA9IHBhdGgucmVzb2x2ZSh0aGlzLmxvYWRQYXRoLCAnQmFzZVBhZ2UuaHRtbCcpO1xyXG5cdFx0aWYoYXdhaXQgZnMuZXhpc3RzKHRlc3RQYXRoKSkge1xyXG5cdFx0XHR0aGlzLmJhc2VQYWdlID0gYXdhaXQgZnMucmVhZEZpbGUocGF0aC5yZXNvbHZlKHRoaXMubG9hZFBhdGgsICdCYXNlUGFnZS5odG1sJyksICdVVEYtOCcpO1xyXG5cdFx0fVxyXG5cdFx0ZWxzZSB7XHJcblx0XHRcdHRoaXMuYmFzZVBhZ2UgPSBhd2FpdCBmcy5yZWFkRmlsZShwYXRoLnJlc29sdmUoX19kaXJuYW1lLCAnLi4vQmFzZVBhZ2UuaHRtbCcpLCAnVVRGLTgnKTtcclxuXHRcdH1cclxuXHRcdHJldHVybiB0aGlzLmJhc2VQYWdlO1xyXG5cdH1cclxufSJdfQ==